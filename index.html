<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"href="img/favicon.png">
    <title>Manga3K</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css" type="text/css">
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap">
    <style>
        .latest-chapters {
            margin-top: 10px;
            text-align: center;
            padding: 0 10px;
        }
        
        .latest-chapters h4 {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .latest-chapters a {
            display: block;
            font-size: 14px;
            color: #007bff;
            text-decoration: none;
            margin-bottom: 5px;
        }
        
        .latest-chapters a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="preloder">
        <div class="loader"></div>
    </div>
    <header class="header py-3">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-1 col-lg-2 text-center text-md-left">
                    <!-- Logo can go here if needed -->
                </div>
                <div class="col-md-10 col-lg-8">
                    <!-- Navbar -->
                    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
                        <a href="index.html" class="navbar-brand">
                            <img src="img/Logo.png" style="width:100px;height:auto;margin-right:20px;" alt="Logo">
                        </a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>


                        <div class="collapse navbar-collapse" id="navbarNav" >
                            <div class="search-container ml-lg-3 d-flex align-items-center">

                                <input type="text" id="search-input" class="form-control mr-2" placeholder="Tìm kiếm truyện...">
                                <button id="search-btn" class="btn btn-danger">
                                    <i class="bi bi-search"></i> <!-- Icon tìm kiếm -->
                                </button>
                            </div>
                            <div id="filter-container" class=" ml-lg-4 d-flex align-items-center mb-1">
                                <div class="dropdown" id="type-select">
                                    <a class="btn" type="button" id="genreDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="bi bi-tags"></i> <!-- Icon thể loại -->
                                        Thể loại
                                    </a>
                                    <div class="mega-menu" aria-labelledby="genreDropdown">
                                        <div id="genre-buttons" class="row">
                                            <!-- Thể loại sẽ được thêm vào đây bởi JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-container ml-lg-4 d-flex align-items-center mb-1">
                                
                                <a href="#" id="dang-phat-hanh" data-type="dang-phat-hanh" style="padding: 6px;">
                                    <i class="bi bi-calendar"></i> <!-- Icon đang phát hành -->
                                    Đang phát hành
                                </a>
                            </div>
                            <div class="filter-container ml-lg-4 d-flex align-items-center mb-1">
                                <a href="#" id="hoan-thanh" data-type="hoan-thanh" style="padding: 6px 0;">
                                    <i class="bi bi-check-circle"></i> <!-- Icon hoàn thành -->
                                    Hoàn thành
                                </a>
                            </div>
                            <div class="filter-container ml-lg-4 d-flex align-items-center mb-1">
                                <a href="#" id="sap-ra-mat" data-type="sap-ra-mat" style="padding: 6px 0;">
                                    <i class="bi bi-clock"></i> <!-- Icon sắp ra mắt -->
                                    Sắp ra mắt
                                </a>
                            </div>
                        </div>
                        
                       
                    </nav>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container mt-4">
        <h1 class="text-center mb-4">Danh Sách Truyện</h1>
        <div id="error-message" class="text-danger text-center"></div>
        <div class="row"> 
            <div class="col-md-1"></div>
           <div class="col-md-8"> <div class="row comic-list mt-5" id="comic-list"></div></div>
            <div class="col-md-2"></div>

        </div>
       
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="pagination__option" id="pagination">
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="index.js"></script>
    <script>
        const comicList = document.getElementById('comic-list');
const pagination = document.getElementById('pagination');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const typeSelect = document.getElementById('type-select');
const genreDropdown = document.getElementById('genreDropdown');
const genreButtons = document.getElementById('genre-buttons');
const errorMessage = document.getElementById('error-message');

let currentPage = 1;
let searchKeyword = '';
let selectedType = '';
let selectedGenre = '';

async function fetchComics(page, keyword = '', type = '', genre = '') {
    try {
        let url = '';
        if (keyword) {
            url = `https://otruyenapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(keyword)}&page=${page}`;
        } else if (genre) {
            url = `https://otruyenapi.com/v1/api/the-loai/${encodeURIComponent(genre)}?page=${page}`;
        } else if (type) {
            url = `https://otruyenapi.com/v1/api/danh-sach/${type}?page=${page}`;
        } else {
            url = `https://otruyenapi.com/v1/api/danh-sach/dang-phat-hanh?page=${page}`;
        }
        console.log('Fetching comics with URL:', url);
        const response = await fetch(url);
        const result = await response.json();
        const data = result.data;

        if (data && data.items && Array.isArray(data.items)) {
            renderComics(data.items);
            const paginationData = data.params && data.params.pagination ? data.params.pagination : {};
            setupPagination(paginationData);

            if (genreButtons.children.length === 0) {
                const genresUrl = 'https://otruyenapi.com/v1/api/the-loai';
                const genresResponse = await fetch(genresUrl);
                const genresResult = await genresResponse.json();
                const genresData = genresResult.data;

                console.log('Genres data:', genresData);
                if (genresData && genresData.items && Array.isArray(genresData.items)) {
                    populateMegaMenu(genresData.items);
                } else {
                    console.error('Dữ liệu trả về không có mảng "items" hoặc không phải là mảng:', genresData.items);
                }
            }
        } else {
            console.error("Dữ liệu trả về không có mảng 'items' hoặc không phải là mảng:", data.items);
            errorMessage.textContent = 'Không có dữ liệu truyện.';
        }
    } catch (error) {
        console.error("Đã xảy ra lỗi khi fetch dữ liệu:", error);
        errorMessage.textContent = 'Không thể tải dữ liệu truyện.';
    }
}

async function fetchLatestChapters(slug) {
    try {
        const response = await fetch(`https://otruyenapi.com/v1/api/truyen-tranh/${slug}`);
        const data = await response.json();

        if (data?.data?.item?.chapters?.[0]?.server_data) {
            const allChapters = data.data.item.chapters[0].server_data;
            // Lấy 3 chương mới nhất (3 phần tử cuối cùng của mảng) và giữ nguyên thứ tự mới nhất
            return allChapters.slice(-3).reverse();
        }
        return [];
    } catch (error) {
        console.error("Lỗi khi lấy chương mới:", error);
        return [];
    }
}

function renderComics(comics) {
    comicList.innerHTML = '';
    comics.forEach(async (comic) => {
        const comicItem = document.createElement('div');
        comicItem.classList.add('col-md-3');

        // Lấy 3 chương mới nhất cho từng truyện
        const latestChapters = await fetchLatestChapters(comic.slug);
        const chaptersHtml = latestChapters.map(chapter => 
            `<a href="MangaDetails.html?slug=${comic.slug}&chapter=${encodeURIComponent(chapter.chapter_api_data)}">
                Chương ${chapter.chapter_name}
            </a>`
        ).join('');

        comicItem.innerHTML = `
            <div class="comic-item">
                <a href="TruyenDetails.html?slug=${comic.slug}">
                    <img src="https://img.otruyenapi.com/uploads/comics/${comic.slug}-thumb.jpg" alt="${comic.name}">
                    <h3>${comic.name}</h3>
                </a>
                <div class="latest-chapters">
                    ${chaptersHtml}
                </div>
            </div>
        `;
        comicList.appendChild(comicItem);
    });
}

function setupPagination(paginationData) {
    pagination.innerHTML = '';
    const currentPage = paginationData.currentPage || 1;
    const totalItems = paginationData.totalItems || 1;
    const itemsPerPage = paginationData.itemsPerPage || 1;
    const totalPages = Math.ceil(totalItems / itemsPerPage);

    if (totalPages > 1) {
        const paginationControls = document.createElement('ul');
        paginationControls.className = 'pagination justify-content-center';

        // Prev button
        if (currentPage > 1) {
            const prevItem = document.createElement('li');
            prevItem.className = 'page-item';
            prevItem.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
            prevItem.addEventListener('click', () => {
                fetchComics(currentPage - 1, searchKeyword, selectedType, selectedGenre);
            });
            paginationControls.appendChild(prevItem);
        }

        // Page buttons
        const startPage = Math.max(1, currentPage - 3);
        const endPage = Math.min(totalPages, currentPage + 3);
        for (let page = startPage; page <= endPage; page++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${page === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#">${page}</a>`;
            pageItem.addEventListener('click', (event) => {
                event.preventDefault();
                fetchComics(page, searchKeyword, selectedType, selectedGenre);
            });
            paginationControls.appendChild(pageItem);
        }

        // Ellipsis if there are more pages
        if (endPage < totalPages) {
            const ellipsisItem = document.createElement('li');
            ellipsisItem.className = 'page-item disabled';
            ellipsisItem.innerHTML = `<span class="page-link">...</span>`;
            paginationControls.appendChild(ellipsisItem);
        }

        // Last page button
        if (totalPages > endPage) {
            const lastPageItem = document.createElement('li');
            lastPageItem.className = 'page-item';
            lastPageItem.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
            lastPageItem.addEventListener('click', (event) => {
                event.preventDefault();
                fetchComics(totalPages, searchKeyword, selectedType, selectedGenre);
            });
            paginationControls.appendChild(lastPageItem);
        }

        // Next button
        if (currentPage < totalPages) {
            const nextItem = document.createElement('li');
            nextItem.className = 'page-item';
            nextItem.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
            nextItem.addEventListener('click', () => {
                fetchComics(currentPage + 1, searchKeyword, selectedType, selectedGenre);
            });
            paginationControls.appendChild(nextItem);
        }

        pagination.appendChild(paginationControls);
    }
}

function populateMegaMenu(genres) {
    genreButtons.innerHTML = '';
    const numColumns = 4;
    const itemsPerColumn = Math.ceil(genres.length / numColumns);

    for (let i = 0; i < numColumns; i++) {
        const column = document.createElement('div');
        column.className = 'genre-column';

        for (let j = i * itemsPerColumn; j < (i + 1) * itemsPerColumn && j < genres.length; j++) {
            const genre = genres[j];
            const button = document.createElement('button');
            button.className = 'btn genre-button';
            button.textContent = genre.name;
            button.addEventListener('click', () => {
                selectedGenre = genre.slug;
                searchKeyword = '';
                currentPage = 1;
                fetchComics(currentPage, searchKeyword, selectedType, selectedGenre);
                document.querySelector('.mega-menu').classList.remove('show');
            });
            column.appendChild(button);
        }

        genreButtons.appendChild(column);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchComics(currentPage);
    
    searchBtn.addEventListener('click', () => {
        searchKeyword = searchInput.value.trim();
        selectedType = '';
        selectedGenre = '';
        currentPage = 1;
        fetchComics(currentPage, searchKeyword);
    });

    typeSelect.addEventListener('change', () => {
        selectedType = typeSelect.value;
        searchKeyword = '';
        selectedGenre = '';
        currentPage = 1;
        fetchComics(currentPage, searchKeyword, selectedType, selectedGenre);
    });

    genreDropdown.addEventListener('click', () => {
        document.querySelector('.mega-menu').classList.toggle('show');
    });

    document.addEventListener('click', (event) => {
        if (!event.target.closest('.dropdown')) {
            document.querySelector('.mega-menu').classList.remove('show');
        }
    });

    document.querySelectorAll('.filter-container a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            selectedType = link.dataset.type;
            selectedGenre = '';
            searchKeyword = '';
            currentPage = 1;
            fetchComics(currentPage, '', selectedType);
        });
    });

    const genreSelect = document.getElementById('genre-select');
    genreSelect.addEventListener('change', () => {
        selectedGenre = genreSelect.value;
        selectedType = '';
        searchKeyword = '';
        currentPage = 1;
        fetchComics(currentPage, '', '', selectedGenre);
    });
});


    </script>
</body>
</html>
